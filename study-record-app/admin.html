<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å›½å®¶è©¦é¨“å¯¾ç­–</title>
    <meta name="description" content="å…¨å­¦ç”Ÿã®å­¦ç¿’è¨˜éŒ²ã‚’ä¸€æ‹¬ç¢ºèª">
    <link rel="stylesheet" href="style.css">
    <style>
        .container {
            max-width: 1200px;
        }

        .data-management {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .student-table {
            font-size: 0.85rem;
        }

        .student-table th,
        .student-table td {
            padding: 10px 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
        }

        .back-link {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .sync-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 12px;
        }

        .sync-status.connected {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .sync-status.disconnected {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_yLVKacdFu23fkv3uzEsmgsZfwSjivhw",
            authDomain: "kokushi-study-record.firebaseapp.com",
            projectId: "kokushi-study-record",
            storageBucket: "kokushi-study-record.firebasestorage.app",
            messagingSenderId: "1064513402081",
            appId: "1:1064513402081:web:77e5cc63a0925800b573a0"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ‘¨â€ğŸ« ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="subtitle">å…¨å­¦ç”Ÿã®å­¦ç¿’è¨˜éŒ²ç®¡ç†</p>
        </header>



        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div class="summary-grid" id="summary-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-label">ç™»éŒ²å­¦ç”Ÿæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-records">0</div>
                <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-rate">0%</div>
                <div class="stat-label">å…¨ä½“å¹³å‡æ­£ç­”ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-questions">0</div>
                <div class="stat-label">ç·å•é¡Œæ•°</div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="data-management">
            <button id="export-all-btn" class="btn btn-secondary">ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button id="clear-btn" class="btn btn-secondary">ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="card">
            <h2>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
            <div class="filter-row">
                <div class="form-group">
                    <label for="filter-student">å­¦ç±ç•ªå·</label>
                    <input type="text" id="filter-student" placeholder="æ¤œç´¢...">
                </div>
                <div class="form-group">
                    <label for="filter-field">åˆ†é‡</label>
                    <select id="filter-field">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="è§£å‰–å­¦">è§£å‰–å­¦</option>
                        <option value="ç”Ÿç†å­¦">ç”Ÿç†å­¦</option>
                        <option value="é‹å‹•å­¦">é‹å‹•å­¦</option>
                        <option value="ç—…ç†å­¦">ç—…ç†å­¦</option>
                        <option value="è‡¨åºŠåŒ»å­¦">è‡¨åºŠåŒ»å­¦</option>
                        <option value="ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åŒ»å­¦">ãƒªãƒãƒ“ãƒªãƒ†ãƒ¼ã‚·ãƒ§ãƒ³åŒ»å­¦</option>
                        <option value="ç†å­¦ç™‚æ³•è©•ä¾¡å­¦">ç†å­¦ç™‚æ³•è©•ä¾¡å­¦</option>
                        <option value="ç†å­¦ç™‚æ³•æ²»ç™‚å­¦">ç†å­¦ç™‚æ³•æ²»ç™‚å­¦</option>
                        <option value="åœ°åŸŸç†å­¦ç™‚æ³•å­¦">åœ°åŸŸç†å­¦ç™‚æ³•å­¦</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-date">æ—¥ä»˜</label>
                    <input type="date" id="filter-date">
                </div>
            </div>
        </div>

        <!-- å­¦ç”Ÿåˆ¥ã‚µãƒãƒªãƒ¼ -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“Š å­¦ç”Ÿåˆ¥ã‚µãƒãƒªãƒ¼</h2>
            </div>
            <div class="table-container">
                <table class="student-table" id="student-summary-table">
                    <thead>
                        <tr>
                            <th>å­¦ç±ç•ªå·</th>
                            <th>æ°å</th>
                            <th>è¨˜éŒ²æ•°</th>
                            <th>ç·å•é¡Œæ•°</th>
                            <th>å¹³å‡æ­£ç­”ç‡</th>
                            <th>é€²æ—</th>
                        </tr>
                    </thead>
                    <tbody id="student-summary-body">
                    </tbody>
                </table>
            </div>
            <p id="no-students" class="no-records">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>

        <!-- å…¨è¨˜éŒ² -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“‹ å…¨è¨˜éŒ²ä¸€è¦§</h2>
                <span id="record-count" style="color: var(--text-secondary);"></span>
            </div>
            <div class="table-container">
                <table class="student-table" id="all-records-table">
                    <thead>
                        <tr>
                            <th>å­¦ç±ç•ªå·</th>
                            <th>æ°å</th>
                            <th>æ—¥ä»˜</th>
                            <th>æ™‚åˆ»</th>
                            <th>åˆ†é‡</th>
                            <th>å•é¡Œæ•°</th>
                            <th>æ­£ç­”æ•°</th>
                            <th>æ­£ç­”ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="all-records-body">
                    </tbody>
                </table>
            </div>
            <p id="no-records" class="no-records">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </div>

    <footer>
        <p>Â© 2026 å›½å®¶è©¦é¨“å¯¾ç­– å­¦ç¿’è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ </p>
    </footer>

    <script>
        // ============================================
        // æ•™å“¡ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - admin.js
        // ============================================

        const STORAGE_KEY = 'kokushi_admin_records';
        let allRecords = [];

        // --- DOM Elements ---
        const clearBtn = document.getElementById('clear-btn');
        const exportAllBtn = document.getElementById('export-all-btn');
        const filterStudent = document.getElementById('filter-student');
        const filterField = document.getElementById('filter-field');
        const filterDate = document.getElementById('filter-date');

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            // Password protection
            const correctPassword = 'ainopt20';
            const sessionKey = 'kokushi_admin_auth';

            // Check if already authenticated in this session
            if (sessionStorage.getItem(sessionKey) !== 'true') {
                const attempts = 3;
                let authenticated = false;

                for (let i = 0; i < attempts; i++) {
                    const input = prompt(`ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰\n\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ®‹ã‚Š ${attempts - i} å›ï¼‰`);

                    if (input === null) {
                        // User cancelled
                        window.location.href = 'index.html';
                        return;
                    }

                    if (input === correctPassword) {
                        authenticated = true;
                        sessionStorage.setItem(sessionKey, 'true');
                        break;
                    } else {
                        if (i < attempts - 1) {
                            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                    }
                }

                if (!authenticated) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                    window.location.href = 'index.html';
                    return;
                }
            }

            loadRecords();
            setupEventListeners();
            updateDisplay();

            // Start real-time sync from Firestore
            startFirestoreSync();
        });

        // --- Firestore Real-time Sync ---
        let firestoreUpdateTimeout = null;
        let isInitialLoad = true;

        function startFirestoreSync() {
            if (typeof db === 'undefined') {
                console.warn('Firestore not available');
                return;
            }

            // Listen for real-time updates from 'students' collection
            db.collection('students').onSnapshot((snapshot) => {
                console.log('Firestore update received');

                // Clear existing Firestore records and reload
                const firestoreRecords = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.records && Array.isArray(data.records)) {
                        data.records.forEach(record => {
                            firestoreRecords.push({
                                ...record,
                                userId: data.studentId,
                                userName: data.studentName,
                                source: 'firestore'
                            });
                        });
                    }
                });

                // Merge with existing records (remove old firestore records, add new ones)
                allRecords = allRecords.filter(r => r.source !== 'firestore');
                allRecords = [...allRecords, ...firestoreRecords];

                // Sort by timestamp descending
                allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Debounce display updates to prevent flickering
                if (firestoreUpdateTimeout) {
                    clearTimeout(firestoreUpdateTimeout);
                }

                firestoreUpdateTimeout = setTimeout(() => {
                    // Only save to localStorage on initial load, not on every update
                    if (isInitialLoad) {
                        saveRecords();
                        isInitialLoad = false;
                    }
                    updateDisplay();
                }, isInitialLoad ? 0 : 500);

            }, (error) => {
                console.error('Firestore sync error:', error);
            });
        }

        function setupEventListeners() {
            // Buttons
            clearBtn.addEventListener('click', clearAllData);
            exportAllBtn.addEventListener('click', exportAllData);

            // Filters
            filterStudent.addEventListener('input', updateDisplay);
            filterField.addEventListener('change', updateDisplay);
            filterDate.addEventListener('change', updateDisplay);
        }





        // --- Storage ---
        function loadRecords() {
            const saved = localStorage.getItem(STORAGE_KEY);
            allRecords = saved ? JSON.parse(saved) : [];
        }

        function saveRecords() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
        }

        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                allRecords = [];
                saveRecords();
                updateDisplay();
                showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // --- Display ---
        function updateDisplay() {
            const filtered = getFilteredRecords();
            updateSummary(filtered);
            updateStudentSummary(filtered);
            updateRecordsTable(filtered);
        }

        function getFilteredRecords() {
            let records = [...allRecords];

            const studentFilter = filterStudent.value.toLowerCase();
            const fieldFilter = filterField.value;
            const dateFilter = filterDate.value;

            if (studentFilter) {
                records = records.filter(r =>
                    r.userId.toLowerCase().includes(studentFilter) ||
                    r.userName.toLowerCase().includes(studentFilter)
                );
            }

            if (fieldFilter) {
                records = records.filter(r => r.field === fieldFilter);
            }

            if (dateFilter) {
                const dateStr = new Date(dateFilter).toLocaleDateString('ja-JP');
                records = records.filter(r => r.date === dateStr);
            }

            return records;
        }

        function updateSummary(records) {
            const students = new Set(records.map(r => r.userId));
            const totalQuestions = records.reduce((sum, r) => sum + r.attempted, 0);
            const totalCorrect = records.reduce((sum, r) => sum + r.correct, 0);
            const avgRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

            document.getElementById('total-students').textContent = students.size;
            document.getElementById('total-records').textContent = records.length;
            document.getElementById('avg-rate').textContent = avgRate + '%';
            document.getElementById('total-questions').textContent = totalQuestions.toLocaleString();
        }

        function updateStudentSummary(records) {
            const studentMap = new Map();

            records.forEach(r => {
                if (!studentMap.has(r.userId)) {
                    studentMap.set(r.userId, {
                        userId: r.userId,
                        userName: r.userName,
                        recordCount: 0,
                        totalAttempted: 0,
                        totalCorrect: 0
                    });
                }
                const student = studentMap.get(r.userId);
                student.recordCount++;
                student.totalAttempted += r.attempted;
                student.totalCorrect += r.correct;
            });

            const students = Array.from(studentMap.values())
                .map(s => ({
                    ...s,
                    avgRate: s.totalAttempted > 0 ? Math.round((s.totalCorrect / s.totalAttempted) * 100) : 0
                }))
                .sort((a, b) => a.userId.localeCompare(b.userId));

            const tbody = document.getElementById('student-summary-body');
            const noStudents = document.getElementById('no-students');

            if (students.length === 0) {
                tbody.innerHTML = '';
                noStudents.classList.remove('hidden');
                return;
            }

            noStudents.classList.add('hidden');

            tbody.innerHTML = students.map(s => {
                const rateClass = s.avgRate >= 80 ? 'rate-high' :
                    s.avgRate >= 60 ? 'rate-medium' : 'rate-low';
                return `
                    <tr>
                        <td>${s.userId}</td>
                        <td>${s.userName}</td>
                        <td>${s.recordCount}</td>
                        <td>${s.totalAttempted}</td>
                        <td class="${rateClass}">${s.avgRate}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${s.avgRate}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateRecordsTable(records) {
            const tbody = document.getElementById('all-records-body');
            const noRecords = document.getElementById('no-records');
            const recordCount = document.getElementById('record-count');

            recordCount.textContent = `(${records.length}ä»¶)`;

            if (records.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                return;
            }

            noRecords.classList.add('hidden');

            // Sort by date desc, then time desc
            const sorted = [...records].sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.time.localeCompare(a.time);
            });

            tbody.innerHTML = sorted.slice(0, 500).map(r => {
                const rateClass = r.rate >= 80 ? 'rate-high' :
                    r.rate >= 60 ? 'rate-medium' : 'rate-low';
                return `
                    <tr>
                        <td>${r.userId}</td>
                        <td>${r.userName}</td>
                        <td>${r.date}</td>
                        <td>${r.time}</td>
                        <td>${r.field || '-'}</td>
                        <td>${r.attempted}</td>
                        <td>${r.correct}</td>
                        <td class="${rateClass}">${r.rate}%</td>
                    </tr>
                `;
            }).join('');
        }

        // --- Export ---
        function exportAllData() {
            if (allRecords.length === 0) {
                showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const headers = ['å­¦ç±ç•ªå·', 'æ°å', 'æ—¥ä»˜', 'æ™‚åˆ»', 'åˆ†é‡', 'å•é¡Œæ•°', 'æ­£ç­”æ•°', 'æ­£ç­”ç‡(%)'];
            const csvContent = [
                headers.join(','),
                ...allRecords.map(r => [
                    r.userId,
                    r.userName,
                    r.date,
                    r.time,
                    r.field,
                    r.attempted,
                    r.correct,
                    r.rate
                ].join(','))
            ].join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å…¨å­¦ç”Ÿè¨˜éŒ²_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        // --- Toast ---
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            if (type === 'error') toast.style.background = '#ff5252';

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>