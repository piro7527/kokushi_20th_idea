<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - å›½å®¶è©¦é¨“å¯¾ç­–</title>
    <meta name="description" content="å…¨å­¦ç”Ÿã®å­¦ç¿’è¨˜éŒ²ã‚’ä¸€æ‹¬ç¢ºèª">
    <link rel="stylesheet" href="style.css">
    <style>
        .container {
            max-width: 1200px;
        }

        .data-management {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-row .form-group {
            flex: 1;
            min-width: 200px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .student-table {
            font-size: 0.85rem;
        }

        .student-table th,
        .student-table td {
            padding: 10px 8px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent-primary);
        }

        .back-link {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .sync-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-left: 12px;
        }

        .sync-status.connected {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .sync-status.disconnected {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        #delete-selected-btn:not(:disabled) {
            background: rgba(255, 82, 82, 0.8);
            color: white;
        }

        #delete-selected-btn:not(:disabled):hover {
            background: rgba(255, 82, 82, 1);
        }

        .record-checkbox,
        #select-all-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
        }

        .student-table th:first-child,
        .student-table td:first-child {
            width: 40px;
            text-align: center;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 6px 14px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
        }

        .pagination button:disabled {
            opacity: 0.35;
            cursor: default;
        }

        .pagination button.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .pagination .page-info {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA_yLVKacdFu23fkv3uzEsmgsZfwSjivhw",
            authDomain: "kokushi-study-record.firebaseapp.com",
            projectId: "kokushi-study-record",
            storageBucket: "kokushi-study-record.firebasestorage.app",
            messagingSenderId: "1064513402081",
            appId: "1:1064513402081:web:77e5cc63a0925800b573a0"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ‘¨â€ğŸ« ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <p class="subtitle">å…¨å­¦ç”Ÿã®å­¦ç¿’è¨˜éŒ²ç®¡ç†</p>
        </header>



        <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
        <div class="summary-grid" id="summary-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-label">ç™»éŒ²å­¦ç”Ÿæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-records">0</div>
                <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avg-rate">0%</div>
                <div class="stat-label">å…¨ä½“å¹³å‡æ­£ç­”ç‡</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-questions">0</div>
                <div class="stat-label">ç·å•é¡Œæ•°</div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
        <div class="data-management">
            <button id="export-filtered-btn" class="btn btn-secondary">ğŸ“¥ è¡¨ç¤ºä¸­ã®CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (<span
                    id="filtered-count">0</span>ä»¶)</button>
            <button id="export-all-btn" class="btn btn-secondary">ğŸ“¥ å…¨ãƒ‡ãƒ¼ã‚¿CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button id="delete-selected-btn" class="btn btn-secondary" disabled>ğŸ—‘ï¸ é¸æŠã‚’å‰Šé™¤ (<span
                    id="selected-count">0</span>ä»¶)</button>
            <button id="clear-btn" class="btn btn-secondary">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <div class="card">
            <h2>ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
            <div class="filter-row">
                <div class="form-group">
                    <label for="filter-student">å­¦ç±ç•ªå·</label>
                    <input type="text" id="filter-student" placeholder="æ¤œç´¢...">
                </div>
                <div class="form-group">
                    <label for="filter-field">åˆ†é‡</label>
                    <select id="filter-field">
                        <option value="">ã™ã¹ã¦</option>
                        <optgroup label="è§£å‰–å­¦">
                            <option value="è§£å‰–å­¦ï¼šéª¨é–¢ç¯€ãƒ»ç­‹">éª¨é–¢ç¯€ãƒ»ç­‹</option>
                            <option value="è§£å‰–å­¦ï¼šç¥çµŒ">ç¥çµŒ</option>
                            <option value="è§£å‰–å­¦ï¼šè„ˆç®¡">è„ˆç®¡</option>
                            <option value="è§£å‰–å­¦ï¼šå†…è‡“">å†…è‡“</option>
                            <option value="è§£å‰–å­¦ï¼šæ„Ÿè¦šå™¨">æ„Ÿè¦šå™¨</option>
                            <option value="è§£å‰–å­¦ï¼šä½“è¡¨ãƒ»æ–­å±¤è§£å‰–">ä½“è¡¨ãƒ»æ–­å±¤è§£å‰–</option>
                            <option value="è§£å‰–å­¦ï¼šç·è«–ãƒ»çµ„ç¹”">ç·è«–ãƒ»çµ„ç¹”</option>
                        </optgroup>
                        <optgroup label="ç”Ÿç†å­¦">
                            <option value="ç”Ÿç†å­¦ï¼šç¥çµŒãƒ»ç­‹">ç¥çµŒãƒ»ç­‹</option>
                            <option value="ç”Ÿç†å­¦ï¼šæ„Ÿè¦šãƒ»è¨€èª">æ„Ÿè¦šãƒ»è¨€èª</option>
                            <option value="ç”Ÿç†å­¦ï¼šé‹å‹•">é‹å‹•</option>
                            <option value="ç”Ÿç†å­¦ï¼šè‡ªå¾‹ç¥çµŒ">è‡ªå¾‹ç¥çµŒ</option>
                            <option value="ç”Ÿç†å­¦ï¼šå‘¼å¸ãƒ»å¾ªç’°">å‘¼å¸ãƒ»å¾ªç’°</option>
                            <option value="ç”Ÿç†å­¦ï¼šè¡€æ¶²ãƒ»å…ç–«">è¡€æ¶²ãƒ»å…ç–«</option>
                            <option value="ç”Ÿç†å­¦ï¼šåš¥ä¸‹ãƒ»æ¶ˆåŒ–å¸åãƒ»æ’æ³„">åš¥ä¸‹ãƒ»æ¶ˆåŒ–å¸åãƒ»æ’æ³„</option>
                            <option value="ç”Ÿç†å­¦ï¼šå†…åˆ†æ³Œãƒ»æ „é¤Šãƒ»ä»£è¬">å†…åˆ†æ³Œãƒ»æ „é¤Šãƒ»ä»£è¬</option>
                            <option value="ç”Ÿç†å­¦ï¼šä½“æ¸©èª¿ç¯€ãƒ»ç”Ÿæ®–">ä½“æ¸©èª¿ç¯€ãƒ»ç”Ÿæ®–</option>
                            <option value="ç”Ÿç†å­¦ï¼šç·è«–ãƒ»è€åŒ–">ç·è«–ãƒ»è€åŒ–</option>
                        </optgroup>
                        <optgroup label="é‹å‹•å­¦">
                            <option value="é‹å‹•å­¦ï¼šå››è‚¢ã¨ä½“å¹¹ã®é‹å‹•">å››è‚¢ã¨ä½“å¹¹ã®é‹å‹•</option>
                            <option value="é‹å‹•å­¦ï¼šå‹•ä½œè§£æ">å‹•ä½œè§£æ</option>
                            <option value="é‹å‹•å­¦ï¼šå§¿å‹¢ãƒ»æ­©è¡Œ">å§¿å‹¢ãƒ»æ­©è¡Œ</option>
                            <option value="é‹å‹•å­¦ï¼šé‹å‹•åˆ¶å¾¡ãƒ»å­¦ç¿’">é‹å‹•åˆ¶å¾¡ãƒ»å­¦ç¿’</option>
                            <option value="é‹å‹•å­¦ï¼šç·è«–">ç·è«–</option>
                        </optgroup>
                        <optgroup label="è‡¨åºŠåŒ»å­¦">
                            <option value="è‡¨åºŠåŒ»å­¦ï¼šéª¨é–¢ç¯€éšœå®³">éª¨é–¢ç¯€éšœå®³</option>
                            <option value="è‡¨åºŠåŒ»å­¦ï¼šç¥çµŒéšœå®³ãƒ»ç­‹éšœå®³">ç¥çµŒéšœå®³ãƒ»ç­‹éšœå®³</option>
                            <option value="è‡¨åºŠåŒ»å­¦ï¼šç²¾ç¥åŒ»å­¦">ç²¾ç¥åŒ»å­¦</option>
                            <option value="è‡¨åºŠåŒ»å­¦ï¼šå†…éƒ¨éšœå®³">å†…éƒ¨éšœå®³</option>
                            <option value="è‡¨åºŠåŒ»å­¦ï¼šç–¼ç—›ãƒ»ãŒã‚“ãƒ»è€å¹´ãƒ»ä»–">ç–¼ç—›ãƒ»ãŒã‚“ãƒ»è€å¹´ãƒ»ä»–</option>
                        </optgroup>
                        <optgroup label="ãã®ä»–">
                            <option value="ç—…ç†å­¦">ç—…ç†å­¦</option>
                            <option value="è–¬ç†å­¦">è–¬ç†å­¦</option>
                            <option value="è‡¨åºŠå¿ƒç†å­¦">è‡¨åºŠå¿ƒç†å­¦</option>
                            <option value="ãƒªãƒåŒ»å­¦">ãƒªãƒåŒ»å­¦</option>
                            <option value="ãƒªãƒæ¦‚è«–">ãƒªãƒæ¦‚è«–</option>
                            <option value="åŒ»å­¦æ¦‚è«–">åŒ»å­¦æ¦‚è«–</option>
                            <option value="äººé–“ç™ºé”å­¦">äººé–“ç™ºé”å­¦</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-date">æ—¥ä»˜</label>
                    <input type="date" id="filter-date">
                </div>
            </div>
        </div>

        <!-- å­¦ç”Ÿåˆ¥ã‚µãƒãƒªãƒ¼ -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“Š å­¦ç”Ÿåˆ¥ã‚µãƒãƒªãƒ¼</h2>
            </div>
            <div class="table-container">
                <table class="student-table" id="student-summary-table">
                    <thead>
                        <tr>
                            <th>å­¦ç±ç•ªå·</th>
                            <th>æ°å</th>
                            <th>è¨˜éŒ²æ•°</th>
                            <th>ç·å•é¡Œæ•°</th>
                            <th>å¹³å‡æ­£ç­”ç‡</th>
                            <th>é€²æ—</th>
                        </tr>
                    </thead>
                    <tbody id="student-summary-body">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="student-pagination"></div>
            <p id="no-students" class="no-records">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>

        <!-- å…¨è¨˜éŒ² -->
        <div class="card">
            <div class="card-header">
                <h2>ğŸ“‹ å…¨è¨˜éŒ²ä¸€è¦§</h2>
                <span id="record-count" style="color: var(--text-secondary);"></span>
            </div>
            <div class="table-container">
                <table class="student-table" id="all-records-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-checkbox" title="å…¨é¸æŠ/å…¨è§£é™¤"></th>
                            <th>å­¦ç±ç•ªå·</th>
                            <th>æ°å</th>
                            <th>æ—¥ä»˜</th>
                            <th>æ™‚åˆ»</th>
                            <th>åˆ†é‡</th>
                            <th>å•é¡Œæ•°</th>
                            <th>æ­£ç­”æ•°</th>
                            <th>æ­£ç­”ç‡</th>
                        </tr>
                    </thead>
                    <tbody id="all-records-body">
                    </tbody>
                </table>
            </div>
            <div class="pagination" id="records-pagination"></div>
            <p id="no-records" class="no-records">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div>
    </div>

    <footer>
        <p>Â© 2026 å›½å®¶è©¦é¨“å¯¾ç­– å­¦ç¿’è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ </p>
    </footer>

    <script>
        // ============================================
        // æ•™å“¡ç”¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - admin.js
        // ============================================

        const STORAGE_KEY = 'kokushi_admin_records';
        let allRecords = [];

        // --- DOM Elements ---
        const clearBtn = document.getElementById('clear-btn');
        const exportAllBtn = document.getElementById('export-all-btn');
        const exportFilteredBtn = document.getElementById('export-filtered-btn');
        const filteredCountSpan = document.getElementById('filtered-count');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const selectedCountSpan = document.getElementById('selected-count');
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const filterStudent = document.getElementById('filter-student');
        const filterField = document.getElementById('filter-field');
        const filterDate = document.getElementById('filter-date');

        // --- Selection State ---
        let selectedRecordIds = new Set();

        // --- Pagination State ---
        const PAGE_SIZE = 50;
        let studentPage = 1;
        let recordsPage = 1;
        let cachedStudents = [];
        let cachedFilteredRecords = [];

        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', () => {
            // Password protection
            const correctPassword = 'ainopt20';
            const sessionKey = 'kokushi_admin_auth';

            // Check if already authenticated in this session
            if (sessionStorage.getItem(sessionKey) !== 'true') {
                const attempts = 3;
                let authenticated = false;

                for (let i = 0; i < attempts; i++) {
                    const input = prompt(`ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰\n\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ®‹ã‚Š ${attempts - i} å›ï¼‰`);

                    if (input === null) {
                        // User cancelled
                        window.location.href = 'index.html';
                        return;
                    }

                    if (input === correctPassword) {
                        authenticated = true;
                        sessionStorage.setItem(sessionKey, 'true');
                        break;
                    } else {
                        if (i < attempts - 1) {
                            alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                        }
                    }
                }

                if (!authenticated) {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚');
                    window.location.href = 'index.html';
                    return;
                }
            }

            loadRecords();
            setupEventListeners();
            updateDisplay();

            // Start real-time sync from Firestore
            startFirestoreSync();
        });

        // --- Firestore Real-time Sync ---
        let firestoreUpdateTimeout = null;
        let isInitialLoad = true;

        function startFirestoreSync() {
            if (typeof db === 'undefined') {
                console.warn('Firestore not available');
                return;
            }

            // Listen for real-time updates from 'students' collection
            db.collection('students').onSnapshot((snapshot) => {
                console.log('Firestore update received');

                // Clear existing Firestore records and reload
                const firestoreRecords = [];

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.records && Array.isArray(data.records)) {
                        data.records.forEach((record, index) => {
                            firestoreRecords.push({
                                ...record,
                                id: `${doc.id}_${index}`,
                                docId: doc.id,
                                recordIndex: index,
                                userId: data.studentId,
                                userName: data.studentName,
                                source: 'firestore'
                            });
                        });
                    }
                });

                // Merge with existing records (remove old firestore records, add new ones)
                allRecords = allRecords.filter(r => r.source !== 'firestore');
                allRecords = [...allRecords, ...firestoreRecords];

                // Sort by timestamp descending
                allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Debounce display updates to prevent flickering
                if (firestoreUpdateTimeout) {
                    clearTimeout(firestoreUpdateTimeout);
                }

                firestoreUpdateTimeout = setTimeout(() => {
                    // Only save to localStorage on initial load, not on every update
                    if (isInitialLoad) {
                        saveRecords();
                        isInitialLoad = false;
                    }
                    updateDisplay();
                }, isInitialLoad ? 0 : 500);

            }, (error) => {
                console.error('Firestore sync error:', error);
            });
        }

        function setupEventListeners() {
            // Buttons
            clearBtn.addEventListener('click', clearAllData);
            exportAllBtn.addEventListener('click', exportAllData);
            exportFilteredBtn.addEventListener('click', exportFilteredData);
            deleteSelectedBtn.addEventListener('click', deleteSelectedRecords);

            // Select all checkbox
            selectAllCheckbox.addEventListener('change', toggleSelectAll);

            // Filters
            filterStudent.addEventListener('input', updateDisplay);
            filterField.addEventListener('change', updateDisplay);
            filterDate.addEventListener('change', updateDisplay);
        }





        // --- Storage ---
        function loadRecords() {
            const saved = localStorage.getItem(STORAGE_KEY);
            allRecords = saved ? JSON.parse(saved) : [];
        }

        function saveRecords() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
        }

        function clearAllData() {
            if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                allRecords = [];
                selectedRecordIds.clear();
                saveRecords();
                updateDisplay();
                updateSelectionUI();
                showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // --- Selection Functions ---
        function toggleSelectAll() {
            const filtered = getFilteredRecords();
            if (selectAllCheckbox.checked) {
                // Select all filtered records
                filtered.forEach(r => selectedRecordIds.add(r.id));
            } else {
                // Deselect all filtered records
                filtered.forEach(r => selectedRecordIds.delete(r.id));
            }
            updateSelectionUI();
            updateRecordsTable(filtered);
        }

        function toggleRecordSelection(recordId, checkbox) {
            if (checkbox.checked) {
                selectedRecordIds.add(recordId);
            } else {
                selectedRecordIds.delete(recordId);
            }
            updateSelectionUI();
            updateSelectAllCheckbox();
        }

        function updateSelectionUI() {
            const count = selectedRecordIds.size;
            selectedCountSpan.textContent = count;
            deleteSelectedBtn.disabled = count === 0;
        }

        function updateSelectAllCheckbox() {
            const filtered = getFilteredRecords();
            const filteredIds = filtered.map(r => r.id);
            const selectedInFiltered = filteredIds.filter(id => selectedRecordIds.has(id));

            if (selectedInFiltered.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedInFiltered.length === filteredIds.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }

        async function deleteSelectedRecords() {
            const count = selectedRecordIds.size;
            if (count === 0) {
                showToast('å‰Šé™¤ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            if (!confirm(`é¸æŠã—ãŸ ${count} ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» Firestoreã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }

            try {
                // Group records by Firestore document
                const deleteByDoc = new Map();

                selectedRecordIds.forEach(recordId => {
                    const record = allRecords.find(r => r.id === recordId);
                    if (record && record.source === 'firestore' && record.docId) {
                        if (!deleteByDoc.has(record.docId)) {
                            deleteByDoc.set(record.docId, []);
                        }
                        deleteByDoc.get(record.docId).push(record.recordIndex);
                    }
                });

                // Delete from Firestore
                for (const [docId, indices] of deleteByDoc) {
                    const docRef = db.collection('students').doc(docId);
                    const docSnap = await docRef.get();

                    if (docSnap.exists) {
                        const data = docSnap.data();
                        if (data.records && Array.isArray(data.records)) {
                            // Sort indices in descending order to delete from end first
                            const sortedIndices = indices.sort((a, b) => b - a);
                            let newRecords = [...data.records];

                            sortedIndices.forEach(index => {
                                if (index >= 0 && index < newRecords.length) {
                                    newRecords.splice(index, 1);
                                }
                            });

                            await docRef.update({ records: newRecords });
                        }
                    }
                }

                // Remove from local records
                allRecords = allRecords.filter(r => !selectedRecordIds.has(r.id));
                selectedRecordIds.clear();

                saveRecords();
                updateDisplay();
                updateSelectionUI();

                showToast(`${count} ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('Delete error:', error);
                showToast('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
            }
        }

        // --- Display ---
        function updateDisplay() {
            // Reset pagination when filters change
            studentPage = 1;
            recordsPage = 1;
            const filtered = getFilteredRecords();
            updateSummary(filtered);
            updateStudentSummary(filtered);
            updateRecordsTable(filtered);
            // Update filtered count for export button
            filteredCountSpan.textContent = filtered.length;
        }

        function getFilteredRecords() {
            let records = [...allRecords];

            const studentFilter = filterStudent.value.toLowerCase();
            const fieldFilter = filterField.value;
            const dateFilter = filterDate.value;

            if (studentFilter) {
                records = records.filter(r =>
                    r.userId.toLowerCase().includes(studentFilter) ||
                    r.userName.toLowerCase().includes(studentFilter)
                );
            }

            if (fieldFilter) {
                records = records.filter(r => r.field === fieldFilter);
            }

            if (dateFilter) {
                const dateStr = new Date(dateFilter).toLocaleDateString('ja-JP');
                records = records.filter(r => r.date === dateStr);
            }

            return records;
        }

        function updateSummary(records) {
            const students = new Set(records.map(r => r.userId));
            const totalQuestions = records.reduce((sum, r) => sum + r.attempted, 0);
            const totalCorrect = records.reduce((sum, r) => sum + r.correct, 0);
            const avgRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;

            document.getElementById('total-students').textContent = students.size;
            document.getElementById('total-records').textContent = records.length;
            document.getElementById('avg-rate').textContent = avgRate + '%';
            document.getElementById('total-questions').textContent = totalQuestions.toLocaleString();
        }

        function updateStudentSummary(records) {
            const studentMap = new Map();

            records.forEach(r => {
                if (!studentMap.has(r.userId)) {
                    studentMap.set(r.userId, {
                        userId: r.userId,
                        userName: r.userName,
                        recordCount: 0,
                        totalAttempted: 0,
                        totalCorrect: 0
                    });
                }
                const student = studentMap.get(r.userId);
                student.recordCount++;
                student.totalAttempted += r.attempted;
                student.totalCorrect += r.correct;
            });

            cachedStudents = Array.from(studentMap.values())
                .map(s => ({
                    ...s,
                    avgRate: s.totalAttempted > 0 ? Math.round((s.totalCorrect / s.totalAttempted) * 100) : 0
                }))
                .sort((a, b) => a.userId.localeCompare(b.userId));

            const tbody = document.getElementById('student-summary-body');
            const noStudents = document.getElementById('no-students');

            if (cachedStudents.length === 0) {
                tbody.innerHTML = '';
                noStudents.classList.remove('hidden');
                document.getElementById('student-pagination').innerHTML = '';
                return;
            }

            noStudents.classList.add('hidden');

            // Clamp page
            const totalPages = Math.ceil(cachedStudents.length / PAGE_SIZE);
            if (studentPage > totalPages) studentPage = totalPages;

            const start = (studentPage - 1) * PAGE_SIZE;
            const pageData = cachedStudents.slice(start, start + PAGE_SIZE);

            tbody.innerHTML = pageData.map(s => {
                const rateClass = s.avgRate >= 80 ? 'rate-high' :
                    s.avgRate >= 60 ? 'rate-medium' : 'rate-low';
                return `
                    <tr>
                        <td>${s.userId}</td>
                        <td>${s.userName}</td>
                        <td>${s.recordCount}</td>
                        <td>${s.totalAttempted}</td>
                        <td class="${rateClass}">${s.avgRate}%</td>
                        <td>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${s.avgRate}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            renderPagination('student-pagination', cachedStudents.length, studentPage, (p) => {
                studentPage = p;
                updateStudentSummary(getFilteredRecords());
            });
        }

        function updateRecordsTable(records) {
            const tbody = document.getElementById('all-records-body');
            const noRecords = document.getElementById('no-records');
            const recordCount = document.getElementById('record-count');

            recordCount.textContent = `(${records.length}ä»¶)`;

            if (records.length === 0) {
                tbody.innerHTML = '';
                noRecords.classList.remove('hidden');
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                document.getElementById('records-pagination').innerHTML = '';
                return;
            }

            noRecords.classList.add('hidden');

            // Sort by date desc, then time desc
            cachedFilteredRecords = [...records].sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.time.localeCompare(a.time);
            });

            // Clamp page
            const totalPages = Math.ceil(cachedFilteredRecords.length / PAGE_SIZE);
            if (recordsPage > totalPages) recordsPage = totalPages;

            const start = (recordsPage - 1) * PAGE_SIZE;
            const pageData = cachedFilteredRecords.slice(start, start + PAGE_SIZE);

            tbody.innerHTML = pageData.map(r => {
                const rateClass = r.rate >= 80 ? 'rate-high' :
                    r.rate >= 60 ? 'rate-medium' : 'rate-low';
                const isChecked = selectedRecordIds.has(r.id) ? 'checked' : '';
                return `
                    <tr>
                        <td><input type="checkbox" class="record-checkbox" data-id="${r.id}" ${isChecked} onchange="toggleRecordSelection('${r.id}', this)"></td>
                        <td>${r.userId}</td>
                        <td>${r.userName}</td>
                        <td>${r.date}</td>
                        <td>${r.time}</td>
                        <td>${r.field || '-'}</td>
                        <td>${r.attempted}</td>
                        <td>${r.correct}</td>
                        <td class="${rateClass}">${r.rate}%</td>
                    </tr>
                `;
            }).join('');

            // Update select all checkbox state
            updateSelectAllCheckbox();

            renderPagination('records-pagination', cachedFilteredRecords.length, recordsPage, (p) => {
                recordsPage = p;
                updateRecordsTable(getFilteredRecords());
            });
        }

        // --- Pagination Renderer ---
        function renderPagination(containerId, totalItems, currentPage, onPageChange) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Prev button
            html += `<button onclick="this._handler()" ${currentPage === 1 ? 'disabled' : ''}>â—€ å‰ã¸</button>`;

            // Page numbers (show max 7 pages around current)
            const maxButtons = 7;
            let startP = Math.max(1, currentPage - Math.floor(maxButtons / 2));
            let endP = Math.min(totalPages, startP + maxButtons - 1);
            if (endP - startP < maxButtons - 1) startP = Math.max(1, endP - maxButtons + 1);

            if (startP > 1) {
                html += `<button onclick="this._handler()">1</button>`;
                if (startP > 2) html += `<span class="page-info">...</span>`;
            }

            for (let i = startP; i <= endP; i++) {
                html += `<button class="${i === currentPage ? 'active' : ''}" onclick="this._handler()">${i}</button>`;
            }

            if (endP < totalPages) {
                if (endP < totalPages - 1) html += `<span class="page-info">...</span>`;
                html += `<button onclick="this._handler()">${totalPages}</button>`;
            }

            // Next button
            html += `<button onclick="this._handler()" ${currentPage === totalPages ? 'disabled' : ''}>æ¬¡ã¸ â–¶</button>`;

            // Page info
            html += `<span class="page-info">${(currentPage - 1) * PAGE_SIZE + 1}-${Math.min(currentPage * PAGE_SIZE, totalItems)}ä»¶ / å…¨${totalItems}ä»¶</span>`;

            container.innerHTML = html;

            // Attach handlers
            const buttons = container.querySelectorAll('button');
            let btnIdx = 0;
            // Prev
            buttons[btnIdx++]._handler = () => onPageChange(currentPage - 1);
            // Page numbers
            if (startP > 1) {
                buttons[btnIdx++]._handler = () => onPageChange(1);
            }
            for (let i = startP; i <= endP; i++) {
                const page = i;
                buttons[btnIdx++]._handler = () => onPageChange(page);
            }
            if (endP < totalPages) {
                buttons[btnIdx++]._handler = () => onPageChange(totalPages);
            }
            // Next
            buttons[btnIdx++]._handler = () => onPageChange(currentPage + 1);
        }

        // --- Export ---
        function exportAllData() {
            if (allRecords.length === 0) {
                showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const headers = ['å­¦ç±ç•ªå·', 'æ°å', 'æ—¥ä»˜', 'æ™‚åˆ»', 'åˆ†é‡', 'å•é¡Œæ•°', 'æ­£ç­”æ•°', 'æ­£ç­”ç‡(%)'];
            const csvContent = [
                headers.join(','),
                ...allRecords.map(r => [
                    r.userId,
                    r.userName,
                    r.date,
                    r.time,
                    r.field,
                    r.attempted,
                    r.correct,
                    r.rate
                ].join(','))
            ].join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å…¨å­¦ç”Ÿè¨˜éŒ²_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        }

        function exportFilteredData() {
            const filtered = getFilteredRecords();
            if (filtered.length === 0) {
                showToast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            const headers = ['å­¦ç±ç•ªå·', 'æ°å', 'æ—¥ä»˜', 'æ™‚åˆ»', 'åˆ†é‡', 'å•é¡Œæ•°', 'æ­£ç­”æ•°', 'æ­£ç­”ç‡(%)'];
            const csvContent = [
                headers.join(','),
                ...filtered.map(r => [
                    r.userId,
                    r.userName,
                    r.date,
                    r.time,
                    r.field,
                    r.attempted,
                    r.correct,
                    r.rate
                ].join(','))
            ].join('\n');

            const bom = '\uFEFF';
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `å­¦ç¿’è¨˜éŒ²_ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showToast(`${filtered.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
        }

        // --- Toast ---
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            if (type === 'error') toast.style.background = '#ff5252';

            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>

</html>